---
layout: notes
title: "Математические основы"
lecture: "vector-databases-ann"
order: 3
description: "Евклидова норма, нормализация векторов, гиперплоскости и их применение в алгоритме Annoy"
estimated_reading: "10 мин"
---

# Математические основы

## Евклидова норма (длина вектора)

**Определение:**

Для вектора $a = (a_1, a_2, \cdots, a_d)$

$$
\|a\| = \sqrt{a_1^2 + a_2^2 + \dots + a_d^2}
$$

* Это расстояние от начала координат до точки-вектора.

---

## Нормализация вектора

**Нормализация:**

$$
n = \frac{a}{\|a\|}
$$

* Превращает вектор в единичный (длина = 1), сохраняет направление.

---

## Направляющий и нормальный вектор

* **Направляющий вектор**: указывает направление линии/прямой.

* **Нормальный вектор**: перпендикулярен (ортогонален) прямой, плоскости или гиперплоскости.

* **Ортогональность:**

Два вектора $a$ и $b$ ортогональны, если $a \cdot b = 0$ (их скалярное произведение = 0).

---

## Гиперплоскость

**Определение:**

В $d$-мерном пространстве:

$$
n \cdot x = d
$$

* $n$ — нормальный вектор (размерности $d$)
* $x$ — произвольная точка в пространстве
* $d$ — смещение (offset)

**Размерность:**

В $d$-мерном пространстве гиперплоскость — объект размерности $d-1$ (например, плоскость в 3D, прямая в 2D).

**Геометрический смысл:**

Все точки, удовлетворяющие уравнению, лежат на гиперплоскости.

Точки $n \cdot x > d$ и $n \cdot x < d$ — по разные стороны гиперплоскости.

---

## Построение дерева Annoy (RAG)

1. Для каждого дерева рекурсивно разбиваем множество векторов с помощью гиперплоскостей.

2. На каждом шаге выбираем два случайных вектора $u, v$, строим нормальный вектор:

$$
n = \frac{u - v}{\|u - v\|}
$$

Смещение (обычно через середину между $u$ и $v$):

$$
m = \frac{u + v}{2}, \quad d = n \cdot m
$$

3. Для каждого вектора $w$ вычисляем $n \cdot w - d$ и относим его к одной из сторон гиперплоскости.

4. Повторяем процесс для каждой части, пока не достигнем "малого" количества векторов в листе.

5. В результате получаем дерево, которое быстро делит пространство на "близкие" группы векторов.

---

## Ключевые понятия

* **Гиперплоскость**: тождественно задаётся уравнением $n \cdot x = d$.

* **Нормальный вектор**: ортогонален гиперплоскости, определяет "направление разреза".

* **Annoy**: использует случайные гиперплоскости для эффективного построения индекса поиска ближайших соседей.

---

## Полезные ассоциации

* "Перпендикулярный" = "ортогональный" (векторы с углом 90°, скалярное произведение = 0).

* Точка лежит на гиперплоскости ⇔ $n \cdot x = d$.

* Векторы в Annoy делятся по знаку $n \cdot x - d$: одна часть — слева, другая — справа.

---

## Определение стороны гиперплоскости для эмбеддинга в Annoy

Для заданного эмбеддинга $w$ и гиперплоскости $n \cdot x = d$:

**Вычисляем значение:** $s = n \cdot w - d$

* Если $s > 0$: эмбеддинг лежит по одну сторону гиперплоскости (например, "справа")
* Если $s < 0$: по другую сторону ("слева")
* Если $s = 0$: эмбеддинг лежит точно на гиперплоскости

Это позволяет Annoy на каждом шаге рекурсивного обхода дерева выбрать, в какое поддерево спускаться при поиске ближайших соседей.

---

## Применение

Annoy строит **много** таких деревьев, чтобы случайные разрезы позволяли быстро искать близкие эмбеддинги для RAG и других задач. 